{% extends 'base.html' %}
{% block title %}My Profile - MultiStock{% endblock %}
{% block content %}
<style>
.profile-header{background:linear-gradient(135deg,#667eea,#764ba2);border-radius:15px;padding:30px;color:white;margin-bottom:30px}
.avatar-upload{width:120px;height:120px;border-radius:50%;background:white;display:flex;align-items:center;justify-content:center;font-size:3rem;color:#667eea;border:4px solid white;box-shadow:0 4px 15px rgba(0,0,0,0.2)}
.stat-card{border-radius:12px;padding:20px;text-align:center;background:white;box-shadow:0 2px 10px rgba(0,0,0,0.1)}
.tab-pane{display:none}.tab-pane.active{display:block}
</style>
<div class="profile-header">
<div class="d-flex align-items-center">
<div class="avatar-upload me-4"><i class="fas fa-user"></i></div>
<div>
<h2 class="mb-1">{{ user.username }}</h2>
<p class="mb-0 opacity-75"><i class="fas fa-envelope me-2"></i>{{ user.email }}</p>
<p class="mb-0 opacity-75"><i class="fas fa-calendar me-2"></i>Joined {{ user.date_joined|date:"M d, Y" }}</p>
</div>
</div>
</div>
<div class="row mb-4">
<div class="col-md-3"><div class="stat-card"><h3 class="text-primary">1,250</h3><small class="text-muted">Total Orders</small></div></div>
<div class="col-md-3"><div class="stat-card"><h3 class="text-success">â‚¹12.5L</h3><small class="text-muted">Total Sales</small></div></div>
<div class="col-md-3"><div class="stat-card"><h3 class="text-warning">45</h3><small class="text-muted">Products</small></div></div>
<div class="col-md-3"><div class="stat-card"><h3 class="text-info">98%</h3><small class="text-muted">Rating</small></div></div>
</div>

<!-- Tabs Navigation -->
<div class="mb-4">
  <ul class="nav nav-tabs" id="profileTabs" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="personal-tab" data-bs-toggle="tab" data-bs-target="#personal" type="button" role="tab" aria-controls="personal" aria-selected="true">
        <i class="fas fa-user-edit me-2"></i>Personal Information
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="credentials-tab" data-bs-toggle="tab" data-bs-target="#credentials" type="button" role="tab" aria-controls="credentials" aria-selected="false">
        <i class="fas fa-lock me-2"></i>Credentials
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="activity-tab" data-bs-toggle="tab" data-bs-target="#activity" type="button" role="tab" aria-controls="activity" aria-selected="false">
        <i class="fas fa-clock me-2"></i>Recent Activity
      </button>
    </li>
  </ul>
</div>

<div class="tab-content" id="profileTabContent">
  <!-- Personal Information Tab -->
  <div class="tab-pane fade show active" id="personal" role="tabpanel" aria-labelledby="personal-tab">
    <div class="row">
      <div class="col-md-8">
        <div class="card" style="border-radius:15px;border:none;box-shadow:0 4px 15px rgba(0,0,0,0.1)">
          <div class="card-header" style="background:linear-gradient(135deg,#667eea,#764ba2);color:white;border-radius:15px 15px 0 0"><h5 class="mb-0"><i class="fas fa-user-edit me-2"></i>Profile Information</h5></div>
          <div class="card-body p-4">
            <form method="post">
              {% csrf_token %}
              <div class="row">
                <div class="col-md-6 mb-3"><label class="form-label fw-bold">Username</label><input type="text" class="form-control" value="{{ user.username }}" readonly style="background:#f8f9fa"></div>
                <div class="col-md-6 mb-3"><label class="form-label fw-bold">Email</label><input type="email" name="email" class="form-control" value="{{ user.email }}"></div>
                <div class="col-md-6 mb-3"><label class="form-label fw-bold">First Name</label><input type="text" name="first_name" class="form-control" value="{{ user.first_name }}"></div>
                <div class="col-md-6 mb-3"><label class="form-label fw-bold">Last Name</label><input type="text" name="last_name" class="form-control" value="{{ user.last_name }}"></div>
              </div>
              <button type="submit" class="btn btn-primary" style="border-radius:10px;padding:10px 30px"><i class="fas fa-save me-2"></i>Update Profile</button>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Credentials Tab -->
  <div class="tab-pane fade" id="credentials" role="tabpanel" aria-labelledby="credentials-tab">
    <div class="row">
      <div class="col-md-8">
        <div class="card" style="border-radius:15px;border:none;box-shadow:0 4px 15px rgba(0,0,0,0.1)">
          <div class="card-header" style="background:linear-gradient(135deg,#f093fb,#f5576c);color:white;border-radius:15px 15px 0 0"><h5 class="mb-0"><i class="fas fa-lock me-2"></i>Change Password</h5></div>
          <div class="card-body p-4">
            <form id="passwordForm">
              {% csrf_token %}
              <div class="mb-3">
                <label class="form-label fw-bold">Current Password</label>
                <input type="password" id="currentPassword" class="form-control" placeholder="Enter your current password" required>
              </div>
              <div class="mb-3">
                <label class="form-label fw-bold">New Password</label>
                <input type="password" id="newPassword" class="form-control" placeholder="Enter your new password" required>
                <small class="text-muted d-block mt-1"><i class="fas fa-info-circle me-1"></i>Password must be at least 8 characters long</small>
              </div>
              <div class="mb-3">
                <label class="form-label fw-bold">Confirm New Password</label>
                <input type="password" id="confirmPassword" class="form-control" placeholder="Confirm your new password" required>
              </div>
              <div id="passwordMessage" class="mb-3" style="display:none;"></div>
              <button type="button" class="btn btn-success" onclick="changePassword()" style="border-radius:10px;padding:10px 30px"><i class="fas fa-key me-2"></i>Change Password</button>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Activity Tab -->
  <div class="tab-pane fade" id="activity" role="tabpanel" aria-labelledby="activity-tab">
    <div class="row">
      <div class="col-md-8">
        <div class="card" style="border-radius:15px;border:none;box-shadow:0 4px 15px rgba(0,0,0,0.1)">
          <div class="card-header" style="background:linear-gradient(135deg,#667eea,#764ba2);color:white;border-radius:15px 15px 0 0"><h5 class="mb-0"><i class="fas fa-clock me-2"></i>Recent Activity</h5></div>
          <div class="card-body p-3">
            <div class="mb-3 pb-3 border-bottom"><small class="text-muted"><i class="fas fa-shopping-cart me-2"></i>Created order #12345</small><br><small class="text-muted">2 hours ago</small></div>
            <div class="mb-3 pb-3 border-bottom"><small class="text-muted"><i class="fas fa-box me-2"></i>Added new product</small><br><small class="text-muted">5 hours ago</small></div>
            <div class="mb-0"><small class="text-muted"><i class="fas fa-user-edit me-2"></i>Updated profile</small><br><small class="text-muted">1 day ago</small></div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
function changePassword() {
    const currentPassword = document.getElementById('currentPassword').value;
    const newPassword = document.getElementById('newPassword').value;
    const confirmPassword = document.getElementById('confirmPassword').value;
    const messageEl = document.getElementById('passwordMessage');

    // Validation
    if (!currentPassword || !newPassword || !confirmPassword) {
        showMessage('Please fill in all password fields', 'danger');
        return;
    }

    if (newPassword.length < 8) {
        showMessage('New password must be at least 8 characters long', 'danger');
        return;
    }

    if (newPassword !== confirmPassword) {
        showMessage('New passwords do not match', 'danger');
        return;
    }

    if (currentPassword === newPassword) {
        showMessage('New password must be different from current password', 'danger');
        return;
    }

    // Send to server
    fetch('/auth/change-password/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value || getCookie('csrftoken')
        },
        body: JSON.stringify({
            current_password: currentPassword,
            new_password: newPassword
        })
    })
    .then(r => r.json())
    .then(d => {
        if (d.success) {
            showMessage('Password changed successfully!', 'success');
            document.getElementById('passwordForm').reset();
            setTimeout(() => {
                window.location.href = '/profile/';
            }, 2000);
        } else {
            showMessage(d.message || 'Failed to change password', 'danger');
        }
    })
    .catch(e => {
        console.error('Error:', e);
        showMessage('Error changing password. Please try again.', 'danger');
    });
}

function showMessage(message, type) {
    const messageEl = document.getElementById('passwordMessage');
    messageEl.className = `alert alert-${type} alert-dismissible fade show`;
    messageEl.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    messageEl.style.display = 'block';
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock %}
