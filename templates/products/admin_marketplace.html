{% extends 'base.html' %}
{% load static %}

{% block title %}Admin Marketplace - MultiStock{% endblock %}

{% block content %}
<div class="container-fluid p-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2><i class="fas fa-store me-2"></i>Admin Marketplace</h2>
            <p class="text-muted mb-0">Manage marketplace products and vendors</p>
        </div>
        <div>
            <span class="badge bg-danger fs-6">
                <i class="fas fa-crown me-1"></i>{{ user_role|title }} Access
            </span>
        </div>
    </div>

    <!-- Stats -->
    <div class="row g-3 mb-4">
        <div class="col-md-3">
            <div class="card border-0 shadow-sm">
                <div class="card-body text-center">
                    <i class="fas fa-box text-primary mb-2" style="font-size: 2rem;"></i>
                    <h3 class="mb-0">{{ total_products|default:0 }}</h3>
                    <small class="text-muted">Total Products</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm">
                <div class="card-body text-center">
                    <i class="fas fa-users text-success mb-2" style="font-size: 2rem;"></i>
                    <h3 class="mb-0">0</h3>
                    <small class="text-muted">Vendors</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm">
                <div class="card-body text-center">
                    <i class="fas fa-shopping-cart text-info mb-2" style="font-size: 2rem;"></i>
                    <h3 class="mb-0">0</h3>
                    <small class="text-muted">Sales</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm">
                <div class="card-body text-center">
                    <i class="fas fa-rupee-sign text-warning mb-2" style="font-size: 2rem;"></i>
                    <h3 class="mb-0">₹0</h3>
                    <small class="text-muted">Revenue</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Marketplace Management -->
    <div class="row g-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-list me-2"></i>Marketplace Products</h5>
                    <a href="/products/" class="btn btn-primary">
                        <i class="fas fa-plus me-2"></i>Add Product
                    </a>
                </div>
                <div class="card-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Admin Marketplace:</strong> Manage all marketplace products, vendors, and sales. You
                        have full control over the marketplace.
                    </div>

                    <!-- Filters -->
                    <div class="row g-3 mb-4">
                        <div class="col-md-4">
                            <input type="text" class="form-control" id="marketplaceSearch" placeholder="Search products..." onkeyup="filterProducts()">
                        </div>
                        <div class="col-md-3">
                            <select class="form-select" id="marketplaceCategory" onchange="filterProducts()">
                                <option value="">All Categories</option>
                                {% for category in categories %}
                                <option value="{{ category }}">{{ category }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-3">
                            <select class="form-select" id="marketplaceSupplier" onchange="filterProducts()">
                                <option value="">All Suppliers</option>
                                {% for supplier in suppliers %}
                                <option value="{{ supplier }}">{{ supplier }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-2">
                            <a href="/products/" class="btn btn-outline-primary w-100">
                                <i class="fas fa-box me-2"></i>Manage Products
                            </a>
                        </div>
                    </div>

                    <!-- Products Table -->
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Image</th>
                                    <th>Product</th>
                                    <th>SKU</th>
                                    <th>Supplier</th>
                                    <th>Category</th>
                                    <th>Price</th>
                                    <th>Stock</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="productsTableBody">
                                {% for product in products %}
                                <tr class="product-row" data-name="{{ product.goods_desc|lower }}" data-category="{{ product.goods_class|lower }}" data-supplier="{{ product.goods_supplier|lower }}">
                                    <td><strong>{{ forloop.counter }}</strong></td>
                                    <td>
                                        {% if product.stock_image %}
                                        <img src="{{ product.stock_image }}" alt="{{ product.goods_desc }}" style="width: 50px; height: 50px; object-fit: cover; border-radius: 4px;" onerror="this.src='/static/images/no-image.svg'">
                                        {% else %}
                                        <i class="fas fa-box text-muted" style="font-size: 2rem;"></i>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <strong>{{ product.goods_desc }}</strong>
                                        {% if product.goods_name %}
                                        <br><small class="text-muted">{{ product.goods_name }}</small>
                                        {% endif %}
                                    </td>
                                    <td><code>{{ product.goods_code }}</code></td>
                                    <td>{{ product.goods_supplier|default:"N/A" }}</td>
                                    <td><span class="badge bg-secondary">{{ product.goods_class|default:"General" }}</span></td>
                                    <td><strong>₹{{ product.goods_price|default:0 }}</strong></td>
                                    <td>
                                        {% if product.stock_available > 0 %}
                                        <span class="badge bg-success">{{ product.stock_available }} available</span>
                                        {% else %}
                                        <span class="badge bg-danger">Out of Stock</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <span class="badge bg-primary">Active</span>
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm">
                                            <a href="/products/{{ product.id }}/" class="btn btn-outline-primary" title="View">
                                                <i class="fas fa-eye"></i>
                                            </a>
                                            <a href="/products/" class="btn btn-outline-warning" title="Edit">
                                                <i class="fas fa-edit"></i>
                                            </a>
                                        </div>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="10" class="text-center text-muted py-5">
                                        <i class="fas fa-box-open" style="font-size: 3rem; opacity: 0.3;"></i>
                                        <p class="mt-3">No products found</p>
                                        <a href="/products/" class="btn btn-primary">
                                            <i class="fas fa-plus me-2"></i>Add Products
                                        </a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="row g-4 mt-4">
        <div class="col-md-4">
            <div class="card border-primary">
                <div class="card-body text-center">
                    <i class="fas fa-users-cog text-primary mb-3" style="font-size: 3rem;"></i>
                    <h5>Manage Vendors</h5>
                    <p class="text-muted small">Add, edit, or remove marketplace vendors</p>
                    <button class="btn btn-outline-primary">
                        <i class="fas fa-arrow-right me-2"></i>Manage
                    </button>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card border-success">
                <div class="card-body text-center">
                    <i class="fas fa-chart-line text-success mb-3" style="font-size: 3rem;"></i>
                    <h5>View Analytics</h5>
                    <p class="text-muted small">Track marketplace performance and sales</p>
                    <button class="btn btn-outline-success">
                        <i class="fas fa-arrow-right me-2"></i>View
                    </button>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card border-info">
                <div class="card-body text-center">
                    <i class="fas fa-cog text-info mb-3" style="font-size: 3rem;"></i>
                    <h5>Settings</h5>
                    <p class="text-muted small">Configure marketplace settings and rules</p>
                    <button class="btn btn-outline-info">
                        <i class="fas fa-arrow-right me-2"></i>Configure
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function filterProducts() {
    const search = document.getElementById('marketplaceSearch').value.toLowerCase();
    const category = document.getElementById('marketplaceCategory').value.toLowerCase();
    const supplier = document.getElementById('marketplaceSupplier').value.toLowerCase();
    
    const rows = document.querySelectorAll('.product-row');
    let visibleCount = 0;
    
    rows.forEach(row => {
        const name = row.getAttribute('data-name') || '';
        const rowCategory = row.getAttribute('data-category') || '';
        const rowSupplier = row.getAttribute('data-supplier') || '';
        
        const matchesSearch = !search || name.includes(search);
        const matchesCategory = !category || rowCategory === category;
        const matchesSupplier = !supplier || rowSupplier === supplier;
        
        if (matchesSearch && matchesCategory && matchesSupplier) {
            row.style.display = '';
            visibleCount++;
        } else {
            row.style.display = 'none';
        }
    });
    
    // Show empty message if no products visible
    const emptyRow = document.querySelector('tbody tr:not(.product-row)');
    if (visibleCount === 0 && rows.length > 0) {
        if (!emptyRow || emptyRow.classList.contains('product-row')) {
            const tbody = document.getElementById('productsTableBody');
            const emptyMsg = document.createElement('tr');
            emptyMsg.innerHTML = `
                <td colspan="9" class="text-center text-muted py-5">
                    <i class="fas fa-search" style="font-size: 3rem; opacity: 0.3;"></i>
                    <p class="mt-3">No products match your filters</p>
                </td>
            `;
            tbody.appendChild(emptyMsg);
        }
    } else if (emptyRow && !emptyRow.classList.contains('product-row')) {
        emptyRow.remove();
    }
}
</script>
{% endblock %}