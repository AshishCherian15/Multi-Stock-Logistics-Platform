{% extends 'base.html' %}
{% load static %}

{% block title %}Messages - MultiStock{% endblock %}

{% block content %}
<div class="container-fluid p-4">
    <div class="mb-4">
        <h2><i class="fas fa-comments me-2"></i>Messages</h2>
        <p class="text-muted">Internal messaging system</p>
    </div>

    <div class="row g-4">
        <div class="col-md-4">
            <div class="card">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Conversations</h5>
                    <div class="btn-group">
                        <button class="btn btn-sm btn-primary" onclick="document.getElementById('newChatModal').style.display='block'" title="New Chat">
                            <i class="fas fa-plus"></i>
                        </button>
                        <a href="{% url 'messaging:create_group' %}" class="btn btn-sm btn-outline-primary" title="Create Group">
                            <i class="fas fa-users"></i>
                        </a>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="list-group list-group-flush">
                        {% for conv_data in conversations %}
                        <a href="{% url 'messaging:chat' conv_data.conversation.id %}" class="list-group-item list-group-item-action {% if conv_data.is_pinned %}border-start border-primary border-3{% endif %}">
                            <div class="d-flex w-100 justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    <div class="d-flex align-items-center">
                                        {% if conv_data.is_pinned %}<i class="fas fa-thumbtack text-primary me-2"></i>{% endif %}
                                        <h6 class="mb-1">
                                            {% if conv_data.conversation.is_group %}
                                                <i class="fas fa-users me-1"></i>{{ conv_data.conversation.name }}
                                            {% else %}
                                                {{ conv_data.other_user.get_full_name|default:conv_data.other_user.username }}
                                            {% endif %}
                                        </h6>
                                    </div>
                                    {% if conv_data.last_message %}
                                    <p class="mb-1 text-muted small">
                                        {% if conv_data.last_message.sender == request.user %}<strong>You:</strong> {% endif %}
                                        {{ conv_data.last_message.content|truncatewords:8 }}
                                    </p>
                                    {% endif %}
                                </div>
                                <div class="text-end">
                                    {% if conv_data.last_message %}
                                    <small class="text-muted">{{ conv_data.last_message.timestamp|timesince }} ago</small>
                                    {% endif %}
                                    {% if conv_data.unread > 0 %}
                                    <span class="badge bg-primary rounded-pill mt-1">{{ conv_data.unread }}</span>
                                    {% endif %}
                                </div>
                            </div>
                        </a>
                        {% empty %}
                        <div class="text-center text-muted py-5">
                            <i class="fas fa-inbox" style="font-size: 3rem; opacity: 0.3;"></i>
                            <p class="mt-3">No conversations yet</p>
                            <button class="btn btn-primary btn-sm" onclick="document.getElementById('newChatModal').style.display='block'">
                                <i class="fas fa-plus me-2"></i>Start New Chat
                            </button>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-8">
            <div class="card">
                <div class="card-header bg-white">
                    <h5 class="mb-0">Select a conversation</h5>
                </div>
                <div class="card-body">
                    <div class="text-center text-muted py-5">
                        <i class="fas fa-comments" style="font-size: 5rem; opacity: 0.3;"></i>
                        <p class="mt-3">Select a conversation to start messaging</p>
                        <button class="btn btn-primary mt-3" onclick="document.getElementById('newChatModal').style.display='block'">
                            <i class="fas fa-plus me-2"></i>Start New Conversation
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- New Chat Modal -->
<div id="newChatModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1050;">
    <div style="position: relative; max-width: 500px; margin: 100px auto;">
        <div class="card">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-comment-dots me-2"></i>Start New Chat</h5>
                <button type="button" class="btn-close" onclick="document.getElementById('newChatModal').style.display='none'"></button>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label">Search Users</label>
                    <input type="text" class="form-control" id="userSearch" placeholder="Search by name or username...">
                </div>
                <div id="userList" class="list-group" style="max-height: 400px; overflow-y: auto;">
                    <div class="text-center text-muted py-3">
                        <i class="fas fa-search"></i>
                        <p class="mb-0 small">Type to search users</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
(function() {
let searchTimeout;
const modal = document.getElementById('newChatModal');
const userSearch = document.getElementById('userSearch');
const userList = document.getElementById('userList');

document.querySelectorAll('[data-bs-toggle="modal"][data-bs-target="#newChatModal"]').forEach(btn => {
    btn.addEventListener('click', (e) => {
        e.preventDefault();
        modal.style.display = 'block';
    });
});

modal.addEventListener('click', (e) => {
    if (e.target === modal) modal.style.display = 'none';
});

if (userSearch) {
    userSearch.addEventListener('input', function() {
        clearTimeout(searchTimeout);
        const query = this.value.trim();
        
        if (query.length < 2) {
            userList.innerHTML = '<div class="text-center text-muted py-3"><i class="fas fa-search"></i><p class="mb-0 small">Type at least 2 characters to search</p></div>';
            return;
        }
        
        searchTimeout = setTimeout(() => {
            fetch(`{% url 'messaging:users' %}?search=${encodeURIComponent(query)}`)
                .then(response => response.text())
                .then(html => {
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    const users = doc.querySelectorAll('.user-item');
                    
                    if (users.length === 0) {
                        userList.innerHTML = '<div class="text-center text-muted py-3"><i class="fas fa-user-slash"></i><p class="mb-0 small">No users found</p></div>';
                    } else {
                        userList.innerHTML = '';
                        users.forEach(user => userList.appendChild(user.cloneNode(true)));
                    }
                })
                .catch(() => {
                    userList.innerHTML = '<div class="alert alert-danger m-2"><i class="fas fa-exclamation-triangle me-2"></i>Error loading users</div>';
                });
        }, 300);
    });
}
})();
</script>
{% endblock %}