<!DOCTYPE html>
<html lang="en">
{% load static %}

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}MultiStock{% endblock %}</title>
    <link rel="shortcut icon" href="{% static 'images/favicon.svg' %}">
    <link rel="icon" href="{% static 'images/favicon.svg' %}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="{% static 'css/multistock.css' %}" rel="stylesheet">
    <link href="{% static 'css/sidebar.css' %}" rel="stylesheet">
    <link href="{% static 'css/dark-mode.css' %}" rel="stylesheet">
    <link href="{% static 'css/dark-theme.css' %}" rel="stylesheet">
    <link href="{% static 'css/navbar.css' %}" rel="stylesheet">
    {% block extra_css %}{% endblock %}
</head>

<body>
    {% include 'components/navbar.html' %}

    {% if user.is_authenticated %}
    {% if user.is_staff %}
    {% include 'includes/sidebar.html' %}
    {% else %}
    {% include 'includes/customer_sidebar.html' %}
    {% endif %}
    {% endif %}


    <div class="{% if user.is_authenticated %}main-content{% else %}container{% endif %}"
        style="{% if not user.is_authenticated %}padding-top: 85px;{% endif %}">
        {% if messages %}
        {% for message in messages %}
        <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        {% endfor %}
        {% endif %}
        {% block content %}{% endblock %}

        {% if user.is_authenticated %}
        {% include 'includes/footer.html' %}
        {% endif %}
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{% static 'js/multistock.js' %}"></script>
    <script src="{% static 'js/image-fallback.js' %}"></script>
    <script src="{% static 'js/helpers.js' %}"></script>
    <script src="{% static 'js/theme.js' %}"></script>
    <script src="{% static 'js/theme-toggle.js' %}"></script>
    <script src="{% static 'js/notifications.js' %}"></script>
    <script src="{% static 'js/search.js' %}"></script>
    <script src="{% static 'js/avatar-handler.js' %}"></script>

    <script>
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function () {
            // Notifications already initialized in notifications.js
        });
    </script>
    {% if user.is_authenticated %}
    <script src="{% static 'js/layout-fix.js' %}"></script>
    <script src="{% static 'js/sidebar.js' %}"></script>

    <!-- Universal Enhancements -->
    <script>
        // Universal confirmation dialogs
        function confirmDelete(itemName, callback) {
            if (confirm(`Are you sure you want to delete "${itemName}"? This action cannot be undone.`)) {
                callback();
            }
        }

        // Universal notifications
        function showAlert(message, type = 'info', duration = 5000) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
            alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            alertDiv.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'danger' ? 'exclamation-triangle' : 'info-circle'} me-2"></i>
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(alertDiv);
            setTimeout(() => {
                if (alertDiv.parentNode) alertDiv.parentNode.removeChild(alertDiv);
            }, duration);
        }

        // Universal loading states
        function setLoading(buttonId, loading = true) {
            const btn = document.getElementById(buttonId);
            if (btn) {
                if (loading) {
                    btn.disabled = true;
                    btn.dataset.originalText = btn.innerHTML;
                    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Loading...';
                } else {
                    btn.disabled = false;
                    btn.innerHTML = btn.dataset.originalText || btn.innerHTML;
                }
            }
        }

        // Universal keyboard shortcuts
        document.addEventListener('keydown', function (e) {
            if (e.ctrlKey && e.key === 's') {
                e.preventDefault();
                const saveBtn = document.querySelector('.btn-primary, .btn-success');
                if (saveBtn && !saveBtn.disabled) saveBtn.click();
            }
            if (e.key === 'Escape') {
                const openModal = document.querySelector('.modal.show');
                if (openModal) bootstrap.Modal.getInstance(openModal)?.hide();
            }
        });

        // Initialize tooltips
        document.addEventListener('DOMContentLoaded', function () {
            const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });

            // Clean up any stuck modal backdrops
            cleanupModalBackdrops();
        });

        // Global function to clean up modal backdrops
        function cleanupModalBackdrops() {
            document.querySelectorAll('.modal-backdrop').forEach(el => el.remove());
            document.body.classList.remove('modal-open');
            document.body.style.overflow = '';
            document.body.style.paddingRight = '';
        }

        // Clean up on modal hide
        document.addEventListener('hidden.bs.modal', function () {
            setTimeout(cleanupModalBackdrops, 100);
        });
    </script>

    <style>
        .is-invalid {
            border-color: #dc3545 !important;
            box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25) !important;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .card:hover {
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            transition: box-shadow 0.3s ease;
        }

        .table-hover tbody tr:hover {
            background-color: rgba(0, 123, 255, 0.05);
        }

        .modal-content {
            border-radius: 12px;
            border: none;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .btn {
            border-radius: 8px;
            font-weight: 500;
        }

        .form-control,
        .form-select {
            border-radius: 8px;
        }
    </style>
    {% endif %}
</body>

</html>
