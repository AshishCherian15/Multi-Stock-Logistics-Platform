{% extends 'base.html' %}
{% block title %}Settings - MultiStock{% endblock %}
{% block content %}
<div class="container-fluid py-4">
    <h2 class="mb-4"><i class="fas fa-cog me-2"></i>Settings</h2>
    
    {% if announcements %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-bullhorn me-2"></i>Announcements</h5>
                    {% if user_role == 'superadmin' or user_role == 'admin' %}
                    <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#createAnnouncementModal">
                        <i class="fas fa-plus me-1"></i>New Announcement
                    </button>
                    {% endif %}
                </div>
                <div class="card-body">
                    {% for announcement in announcements %}
                    <div class="alert alert-{% if announcement.priority == 'critical' %}danger{% elif announcement.priority == 'high' %}warning{% elif announcement.priority == 'medium' %}info{% else %}secondary{% endif %} mb-2">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <strong>{{ announcement.title }}</strong>
                                <p class="mb-1">{{ announcement.message }}</p>
                                <small class="text-muted">{{ announcement.created_by.username }} • {{ announcement.created_at|date:"M d, Y" }}</small>
                            </div>
                            <span class="badge bg-{% if announcement.priority == 'critical' %}danger{% elif announcement.priority == 'high' %}warning{% elif announcement.priority == 'medium' %}info{% else %}secondary{% endif %}">{{ announcement.get_priority_display }}</span>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    
    <div class="row">
        <div class="col-md-3">
            <div class="list-group">
                <a href="#profile" class="list-group-item list-group-item-action active" data-bs-toggle="list"><i class="fas fa-user me-2"></i>Profile</a>
                <a href="#security" class="list-group-item list-group-item-action" data-bs-toggle="list"><i class="fas fa-lock me-2"></i>Security</a>
                <a href="#notifications" class="list-group-item list-group-item-action" data-bs-toggle="list"><i class="fas fa-bell me-2"></i>Notifications</a>
                <a href="#preferences" class="list-group-item list-group-item-action" data-bs-toggle="list"><i class="fas fa-sliders-h me-2"></i>Preferences</a>
                {% if user_role == 'superadmin' or user_role == 'admin' %}
                <a href="#announcements" class="list-group-item list-group-item-action" data-bs-toggle="list"><i class="fas fa-bullhorn me-2"></i>Announcements</a>
                <a href="#system" class="list-group-item list-group-item-action" data-bs-toggle="list"><i class="fas fa-server me-2"></i>System</a>
                {% endif %}
                {% if user_role == 'superadmin' %}
                <a href="#maintenance" class="list-group-item list-group-item-action" data-bs-toggle="list"><i class="fas fa-tools me-2"></i>Maintenance</a>
                <a href="#advanced" class="list-group-item list-group-item-action" data-bs-toggle="list"><i class="fas fa-sliders-h me-2"></i>Advanced</a>
                {% endif %}
            </div>
        </div>
        
        <div class="col-md-9">
            <div class="tab-content">
                <div class="tab-pane fade show active" id="profile">
                    <div class="card">
                        <div class="card-header"><h5>Profile Settings</h5></div>
                        <div class="card-body">
                            <form method="post" action="{% url 'update_profile' %}">
                                {% csrf_token %}
                                <div class="mb-3">
                                    <label class="form-label">Full Name</label>
                                    <input type="text" class="form-control" name="full_name" value="{{ user.get_full_name }}">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Email</label>
                                    <input type="email" class="form-control" name="email" value="{{ user.email }}">
                                </div>
                                <button type="submit" class="btn btn-primary">Save Changes</button>
                            </form>
                        </div>
                    </div>
                </div>
                
                <div class="tab-pane fade" id="security">
                    <div class="card">
                        <div class="card-header"><h5>Security Settings</h5></div>
                        <div class="card-body">
                            <form method="post" action="{% url 'change_password' %}">
                                {% csrf_token %}
                                <div class="mb-3">
                                    <label class="form-label">Current Password</label>
                                    <input type="password" class="form-control" name="current_password" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">New Password</label>
                                    <input type="password" class="form-control" name="new_password" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Confirm Password</label>
                                    <input type="password" class="form-control" name="confirm_password" required>
                                </div>
                                <button type="submit" class="btn btn-primary">Update Password</button>
                            </form>
                        </div>
                    </div>
                </div>
                
                <div class="tab-pane fade" id="notifications">
                    <div class="card">
                        <div class="card-header"><h5>Notification Preferences</h5></div>
                        <div class="card-body">
                            <form method="post" action="{% url 'update_notifications' %}">
                                {% csrf_token %}
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" name="email_notifications" {% if user_prefs.notifications.email %}checked{% endif %}>
                                    <label class="form-check-label">Email Notifications</label>
                                </div>
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" name="order_updates" {% if user_prefs.notifications.order_updates %}checked{% endif %}>
                                    <label class="form-check-label">Order Updates</label>
                                </div>
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" name="stock_alerts" {% if user_prefs.notifications.stock_alerts %}checked{% endif %}>
                                    <label class="form-check-label">Stock Alerts</label>
                                </div>
                                <button type="submit" class="btn btn-primary">Save Preferences</button>
                            </form>
                        </div>
                    </div>
                </div>

                <div class="tab-pane fade" id="preferences">
                    <div class="card">
                        <div class="card-header"><h5>Display & Usage</h5></div>
                        <div class="card-body">
                            <form method="post" action="{% url 'save_setting' %}">
                                {% csrf_token %}
                                <input type="hidden" name="form_type" value="preferences">
                                <div class="mb-3">
                                    <label class="form-label">Language</label>
                                    <select class="form-select" name="language">
                                        <option value="en" {% if user_prefs.language == 'en' %}selected{% endif %}>English</option>
                                        <option value="hi" {% if user_prefs.language == 'hi' %}selected{% endif %}>Hindi</option>
                                        <option value="kn" {% if user_prefs.language == 'kn' %}selected{% endif %}>Kannada</option>
                                        <option value="es" {% if user_prefs.language == 'es' %}selected{% endif %}>Spanish</option>
                                        <option value="fr" {% if user_prefs.language == 'fr' %}selected{% endif %}>French</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Theme</label>
                                    <select class="form-select" name="theme">
                                        <option value="light" {% if user_prefs.theme == 'light' %}selected{% endif %}>Light</option>
                                        <option value="dark" {% if user_prefs.theme == 'dark' %}selected{% endif %}>Dark</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Items Per Page</label>
                                    <select class="form-select" name="items_per_page">
                                        <option value="10" {% if user_prefs.items_per_page == 10 %}selected{% endif %}>10</option>
                                        <option value="25" {% if user_prefs.items_per_page == 25 %}selected{% endif %}>25</option>
                                        <option value="50" {% if user_prefs.items_per_page == 50 %}selected{% endif %}>50</option>
                                        <option value="100" {% if user_prefs.items_per_page == 100 %}selected{% endif %}>100</option>
                                    </select>
                                </div>
                                <button type="submit" class="btn btn-primary">Save Preferences</button>
                            </form>
                        </div>
                    </div>
                </div>
                
                {% if user_role == 'superadmin' or user_role == 'admin' %}
                <div class="tab-pane fade" id="announcements">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">Manage Announcements</h5>
                            <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#createAnnouncementModal">
                                <i class="fas fa-plus me-1"></i>New
                            </button>
                        </div>
                        <div class="card-body">
                            <div id="announcementsList"></div>
                        </div>
                    </div>
                </div>
                <script>
                const announcementsApi = "{% url 'get_announcements_api' %}";
                const deleteAnnouncementApi = (id) => `{% url 'delete_announcement' 0 %}`.replace('0', id);

                fetch(announcementsApi)
                    .then(r => r.json())
                    .then(data => {
                        const list = document.getElementById('announcementsList');
                        if (!data.announcements || data.announcements.length === 0) {
                            list.innerHTML = '<p class="text-muted">No announcements</p>';
                        } else {
                            list.innerHTML = data.announcements.map(a => `
                                <div class="border-bottom pb-2 mb-2">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div class="flex-grow-1">
                                            <strong>${a.title}</strong>
                                            <span class="badge bg-${a.priority === 'critical' ? 'danger' : a.priority === 'high' ? 'warning' : 'info'} ms-2">${a.priority}</span>
                                        </div>
                                        <div>
                                            <button class="btn btn-sm btn-outline-primary me-1" onclick="editAnnouncement(${a.id})" title="Edit">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button class="btn btn-sm btn-outline-danger" onclick="deleteAnnouncement(${a.id})" title="Delete">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <p class="mb-1">${a.message}</p>
                                    <small class="text-muted">${a.created_by} • ${a.created_at}</small>
                                </div>
                            `).join('');
                        }
                    });
                </script>
                {% endif %}
                
                
                {% if user_role == 'superadmin' or user_role == 'admin' %}
                <div class="tab-pane fade" id="system">
                    <div class="card">
                        <div class="card-header"><h5>System Settings</h5></div>
                        <div class="card-body">
                            <form method="post" action="{% url 'save_setting' %}">
                                {% csrf_token %}
                                <input type="hidden" name="form_type" value="system">
                                <div class="mb-3">
                                    <label class="form-label">Company Name</label>
                                    <input type="text" class="form-control" name="company_name" value="{{ system_settings.company_name }}">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Currency</label>
                                    <select class="form-select" name="currency">
                                        <option value="INR" {% if system_settings.currency == 'INR' %}selected{% endif %}>INR (₹)</option>
                                        <option value="USD" {% if system_settings.currency == 'USD' %}selected{% endif %}>USD ($)</option>
                                        <option value="EUR" {% if system_settings.currency == 'EUR' %}selected{% endif %}>EUR (€)</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Timezone</label>
                                    <input type="text" class="form-control" name="timezone" value="{{ system_settings.timezone }}" placeholder="e.g., Asia/Kolkata">
                                </div>
                                <button class="btn btn-primary" type="submit">Save Settings</button>
                            </form>
                        </div>
                    </div>
                </div>
                {% endif %}
                
                {% if user_role == 'superadmin' %}
                <div class="tab-pane fade" id="maintenance">
                    <div class="card">
                        <div class="card-header"><h5>Maintenance Mode</h5></div>
                        <div class="card-body">
                            <div class="alert alert-warning">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                Maintenance mode will restrict access for all users except Super Admin
                            </div>
                            <form method="post" action="{% url 'toggle_maintenance' %}">
                                {% csrf_token %}
                                <div class="form-check form-switch mb-3">
                                    <input class="form-check-input" type="checkbox" name="maintenance_mode" id="maintenanceSwitch" {% if maintenance_mode.is_active %}checked{% endif %}>
                                    <label class="form-check-label" for="maintenanceSwitch">Enable Maintenance Mode</label>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Allowed Roles During Maintenance</label>
                                    <select class="form-select" name="allowed_roles" multiple>
                                        {% for role in allowed_roles_options %}
                                        <option value="{{ role }}" {% if maintenance_mode.allowed_roles and role in maintenance_mode.allowed_roles %}selected{% endif %}>{{ role|title }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <button type="submit" class="btn btn-warning">Update Maintenance Settings</button>
                            </form>
                        </div>
                    </div>
                </div>
                
                <div class="tab-pane fade" id="advanced">
                    <div class="card">
                        <div class="card-header"><h5>Advanced Settings</h5></div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label class="form-label">Database Backup</label>
                                <button class="btn btn-info d-block">Create Backup</button>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Clear Cache</label>
                                <button class="btn btn-warning d-block">Clear All Cache</button>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">System Logs</label>
                                <button class="btn btn-secondary d-block">View Logs</button>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Create Announcement Modal -->
{% if user_role == 'superadmin' or user_role == 'admin' %}
<div class="modal fade" id="createAnnouncementModal" tabindex="-1" data-bs-backdrop="false">
    <div class="modal-dialog" style="margin-top: 80px;">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-bullhorn me-2"></i>Create Announcement</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="post" action="{% url 'create_announcement' %}">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Title</label>
                        <input type="text" class="form-control" name="title" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Message</label>
                        <textarea class="form-control" name="message" rows="3" required></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Priority</label>
                        <select class="form-select" name="priority">
                            <option value="low">Low</option>
                            <option value="medium" selected>Medium</option>
                            <option value="high">High</option>
                            <option value="critical">Critical</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Target Roles (Leave empty for all)</label>
                        <select class="form-select" name="target_roles" multiple>
                            <option value="superadmin">Super Admin</option>
                            <option value="admin">Admin</option>
                            <option value="admin">Sub Admin</option>
                            <option value="supervisor">Supervisor</option>
                            <option value="staff">Staff</option>
                            <option value="customer">Customer</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Expires At (Optional)</label>
                        <input type="datetime-local" class="form-control" name="expires_at">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Announcement</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Announcement Modal -->
<div class="modal fade" id="editAnnouncementModal" tabindex="-1" data-bs-backdrop="false">
    <div class="modal-dialog" style="margin-top: 80px;">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-edit me-2"></i>Edit Announcement</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="post" action="{% url 'update_announcement' %}">
                {% csrf_token %}
                <input type="hidden" name="announcement_id" id="editAnnouncementId">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Title</label>
                        <input type="text" class="form-control" name="title" id="editTitle" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Message</label>
                        <textarea class="form-control" name="message" id="editMessage" rows="3" required></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Priority</label>
                        <select class="form-select" name="priority" id="editPriority">
                            <option value="low">Low</option>
                            <option value="medium">Medium</option>
                            <option value="high">High</option>
                            <option value="critical">Critical</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update Announcement</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Remove modal backdrop when modal is hidden
document.getElementById('createAnnouncementModal')?.addEventListener('hidden.bs.modal', function () {
    document.querySelectorAll('.modal-backdrop').forEach(el => el.remove());
    document.body.classList.remove('modal-open');
    document.body.style.overflow = '';
    document.body.style.paddingRight = '';
});

function editAnnouncement(id) {
    fetch(announcementsApi)
        .then(r => r.json())
        .then(data => {
            const announcement = data.announcements.find(a => a.id === id);
            if(announcement) {
                document.getElementById('editAnnouncementId').value = id;
                document.getElementById('editTitle').value = announcement.title;
                document.getElementById('editMessage').value = announcement.message;
                document.getElementById('editPriority').value = announcement.priority;
                new bootstrap.Modal(document.getElementById('editAnnouncementModal')).show();
            }
        });
}

function deleteAnnouncement(id) {
    if(confirm('Are you sure you want to delete this announcement?')) {
        fetch(deleteAnnouncementApi(id), {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json'
            }
        })
        .then(r => r.json())
        .then(data => {
            if(data.success) {
                if(typeof showAlert === 'function') {
                    showAlert('Announcement deleted successfully', 'success');
                }
                location.reload();
            }
        })
        .catch(err => {
            if(typeof showAlert === 'function') {
                showAlert('Failed to delete announcement', 'danger');
            }
        });
    }
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endif %}
{% endblock %}

