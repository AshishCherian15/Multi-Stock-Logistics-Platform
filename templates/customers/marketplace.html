{% extends 'base.html' %}
{% load static %}

{% block title %}Marketplace - Customer Portal{% endblock %}

{% block content %}
<div class="container-fluid p-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="fas fa-store me-2"></i>Product Marketplace</h2>
        <a href="/cart/" class="btn btn-primary">
            <i class="fas fa-shopping-cart me-2"></i>Cart ({{ cart_count|default:0 }})
        </a>
    </div>

<!-- Filters -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card shadow-sm">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="fas fa-filter me-2"></i>Search & Filters</h5>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-4">
                        <input type="text" class="form-control" placeholder="Search products..." id="searchInput" value="{{ search }}">
                    </div>
                    <div class="col-md-3">
                        <select class="form-select" id="categoryFilter">
                            <option value="">All Categories</option>
                            {% for category in categories %}
                            <option value="{{ category.id }}">{{ category.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3">
                        <select class="form-select" id="sortFilter">
                            <option value="">Sort By</option>
                            <option value="name">Name (A-Z)</option>
                            <option value="-name">Name (Z-A)</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <button class="btn btn-primary w-100" onclick="applyFilters()">
                            <i class="fas fa-filter me-2"></i>Filter
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Products Grid -->
<div class="row">
    {% for product in products %}
    <div class="col-md-3 mb-4" data-product-id="{{ product.goods_code }}" data-product-name="{{ product.goods_desc }}" data-product-category="{{ product.category.id }}">
        <div class="card h-100 shadow-sm">
            {% if product.image %}
            <img src="{{ product.image.url }}" class="card-img-top" alt="{{ product.goods_desc }}" style="height: 200px; object-fit: cover;">
            {% else %}
            <div class="card-img-top bg-light d-flex align-items-center justify-content-center" style="height: 200px;">
                <i class="fas fa-image fa-3x text-muted"></i>
            </div>
            {% endif %}
            <div class="card-body d-flex flex-column">
                <h6 class="card-title">{{ product.goods_desc }}</h6>
                <p class="text-muted small mb-2">SKU: {{ product.goods_code }}</p>
                <p class="card-text text-primary fw-bold mb-3">â‚¹{{ product.goods_price|floatformat:2 }}</p>
                <div class="mt-auto d-flex flex-column gap-2">
                    <button class="btn btn-sm btn-primary" onclick="addToCart('{{ product.goods_code }}', '{{ product.goods_desc }}', {{ product.goods_price }}, '{% if product.image %}{{ product.image.url }}{% endif %}')">
                        <i class="fas fa-cart-plus me-1"></i>Add to Cart
                    </button>
                    <button class="btn btn-sm btn-success" onclick="buyNow('{{ product.goods_code }}', '{{ product.goods_desc }}', {{ product.goods_price }}, '{% if product.image %}{{ product.image.url }}{% endif %}')">
                        <i class="fas fa-flash me-1"></i>Buy Now
                    </button>
                    <button class="btn btn-sm btn-outline-danger" onclick="addToWishlist('{{ product.goods_code }}', '{{ product.goods_desc }}', {{ product.goods_price }}, '{% if product.image %}{{ product.image.url }}{% endif %}')">
                        <i class="fas fa-heart"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
    {% empty %}
    <div class="col-12">
        <div class="card shadow-sm">
            <div class="card-body text-center py-5">
                <i class="fas fa-box-open fa-4x text-muted mb-3"></i>
                <h4>No Products Found</h4>
                <p class="text-muted">Try adjusting your search or filters</p>
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<!-- Pagination -->
{% if products.has_other_pages %}
<nav aria-label="Page navigation" class="mt-4">
    <ul class="pagination justify-content-center">
        {% if products.has_previous %}
        <li class="page-item">
            <a class="page-link" href="?page=1{% if search %}&search={{ search }}{% endif %}{% if category %}&category={{ category }}{% endif %}">First</a>
        </li>
        <li class="page-item">
            <a class="page-link" href="?page={{ products.previous_page_number }}{% if search %}&search={{ search }}{% endif %}{% if category %}&category={{ category }}{% endif %}">Previous</a>
        </li>
        {% endif %}

        {% for num in products.paginator.page_range %}
            {% if products.number == num %}
            <li class="page-item active">
                <span class="page-link">{{ num }}</span>
            </li>
            {% else %}
            <li class="page-item">
                <a class="page-link" href="?page={{ num }}{% if search %}&search={{ search }}{% endif %}{% if category %}&category={{ category }}{% endif %}">{{ num }}</a>
            </li>
            {% endif %}
        {% endfor %}

        {% if products.has_next %}
        <li class="page-item">
            <a class="page-link" href="?page={{ products.next_page_number }}{% if search %}&search={{ search }}{% endif %}{% if category %}&category={{ category }}{% endif %}">Next</a>
        </li>
        <li class="page-item">
            <a class="page-link" href="?page={{ products.paginator.num_pages }}{% if search %}&search={{ search }}{% endif %}{% if category %}&category={{ category }}{% endif %}">Last</a>
        </li>
        {% endif %}
    </ul>
</nav>
{% endif %}

<script>
function applyFilters() {
    const search = document.getElementById('searchInput').value.toLowerCase();
    const category = document.getElementById('categoryFilter').value;
    const sort = document.getElementById('sortFilter').value;

    const products = document.querySelectorAll('[data-product-id]');
    let visibleCount = 0;

    products.forEach(product => {
        const productName = (product.dataset.productName || '').toLowerCase();
        const productCategory = product.dataset.productCategory || '';

        const matchSearch = !search || productName.includes(search);
        const matchCategory = !category || productCategory === category;

        if (matchSearch && matchCategory) {
            product.style.display = '';
            visibleCount++;
        } else {
            product.style.display = 'none';
        }
    });

    if (sort === 'name') {
        sortProductsByName();
    } else if (sort === '-name') {
        sortProductsByName(true);
    }
}

function sortProductsByName(reverse = false) {
    const container = document.querySelector('[data-products-container]') || document.body;
    const products = Array.from(container.querySelectorAll('[data-product-id]')).filter(p => p.style.display !== 'none');

    products.sort((a, b) => {
        const nameA = (a.dataset.productName || '').toLowerCase();
        const nameB = (b.dataset.productName || '').toLowerCase();
        return reverse ? nameB.localeCompare(nameA) : nameA.localeCompare(nameB);
    });

    const parent = container.parentElement;
    products.forEach(product => parent.appendChild(product.parentElement));
}

function addToCart(productId, productName, productPrice, productImage) {
    fetch('/cart/api/add/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            product_id: productId,
            title: productName,
            price: productPrice,
            quantity: 1,
            image: productImage || ''
        })
    })
    .then(r => r.json())
    .then(d => {
        if (d.success) {
            showAlert('Product added to cart!', 'success');
            // Update cart count
            updateCartCount();
        } else {
            showAlert('Failed to add product to cart', 'danger');
        }
    })
    .catch(e => {
        showAlert('Error adding to cart', 'danger');
    });
}

function addToWishlist(productId, productName, productPrice, productImage) {
    fetch('/wishlist/api/add/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            product_id: productId,
            title: productName,
            price: productPrice,
            image: productImage || ''
        })
    })
    .then(r => r.json())
    .then(d => {
        if (d.success) {
            showAlert('Product added to wishlist!', 'success');
        } else {
            showAlert('Failed to add product to wishlist', 'danger');
        }
    });
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function showAlert(message, type) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(alertDiv);
    setTimeout(() => {
        if (alertDiv.parentNode) alertDiv.parentNode.removeChild(alertDiv);
    }, 3000);
}

function updateCartCount() {
    fetch('/cart/api/')
    .then(r => r.json())
    .then(d => {
        const cartBtn = document.querySelector('a[href="/cart/"]');
        if (cartBtn) {
            cartBtn.innerHTML = `<i class="fas fa-shopping-cart me-2"></i>Cart (${d.total_items || 0})`;
        }
    });
}

function buyNow(productId, productName, productPrice, productImage) {
    // Add to cart first
    fetch('/cart/api/add/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            product_id: productId,
            title: productName,
            price: productPrice,
            quantity: 1,
            image: productImage || ''
        })
    })
    .then(r => r.json())
    .then(d => {
        if (d.success) {
            // Redirect to checkout
            window.location.href = '/customers/checkout/';
        } else {
            showAlert('Failed to add product. Please try again.', 'danger');
        }
    })
    .catch(e => {
        showAlert('Error processing purchase. Please try again.', 'danger');
    });
}
</script>
</div>
{% endblock %}
