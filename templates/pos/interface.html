{% extends 'base.html' %}
{% load static %}

{% block title %}POS Interface - MultiStock{% endblock %}

{% block content %}
<div class="container-fluid p-4">
    <div class="mb-4 d-flex justify-content-between align-items-center">
        <div>
            <h2><i class="fas fa-cash-register me-2"></i>Point of Sale</h2>
            <p class="text-muted mb-0">Process sales transactions</p>
        </div>
        <div>
            <span class="badge bg-success">Cashier: {{ request.user.get_full_name|default:request.user.username }}</span>
        </div>
    </div>

    <div class="row g-4">
        <div class="col-lg-7">
            <div class="card">
                <div class="card-header bg-white">
                    <div class="input-group">
                        <span class="input-group-text"><i class="fas fa-search"></i></span>
                        <input type="text" id="productSearch" class="form-control" placeholder="Search products by name or code..." autofocus>
                    </div>
                </div>
                <div class="card-body" style="max-height: 600px; overflow-y: auto;">
                    <div id="productGrid" class="row g-3"></div>
                </div>
            </div>
        </div>

        <div class="col-lg-5">
            <div class="card">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-shopping-cart me-2"></i>Cart</h5>
                    <button class="btn btn-sm btn-light" onclick="clearCart()"><i class="fas fa-trash"></i></button>
                </div>
                <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                    <div id="cartItems"></div>
                </div>
                <div class="card-footer bg-white">
                    <div class="mb-3">
                        <label class="form-label">Payment Method</label>
                        <select id="paymentMethod" class="form-select">
                            <option value="cash">Cash</option>
                            <option value="card">Card</option>
                            <option value="upi">UPI</option>
                        </select>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>Subtotal:</span>
                        <strong id="subtotal">₹0.00</strong>
                    </div>
                    <div class="d-flex justify-content-between mb-3">
                        <h5 class="mb-0">Total:</h5>
                        <h5 class="mb-0 text-primary" id="total">₹0.00</h5>
                    </div>
                    <button class="btn btn-outline-primary w-100 mb-2" id="previewBtn" onclick="previewBill()" disabled>
                        <i class="fas fa-eye me-2"></i>Preview Bill
                    </button>
                    <button class="btn btn-success w-100" id="completeSaleBtn" onclick="completeSale()" disabled>
                        <i class="fas fa-check me-2"></i>Complete Sale
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let cart = [];
let products = {{ products|safe }};

function renderProducts(productList) {
    const grid = document.getElementById('productGrid');
    if (!productList || productList.length === 0) {
        grid.innerHTML = '<div class="col-12 text-center text-muted py-5"><i class="fas fa-box-open fa-3x mb-3"></i><p>No products found</p></div>';
        return;
    }
    grid.innerHTML = productList.map(p => `
        <div class="col-md-6 col-lg-4">
            <div class="card h-100 product-card" onclick="addToCart(${p.id})" style="cursor: pointer;">
                <div class="card-body">
                    <h6 class="card-title">${p.name}</h6>
                    <p class="text-muted small mb-2">${p.code}</p>
                    <div class="d-flex justify-content-between align-items-center">
                        <span class="badge bg-success">₹${p.price.toFixed(2)}</span>
                        <small class="text-muted">Stock: ${p.stock}</small>
                    </div>
                </div>
            </div>
        </div>
    `).join('');
}

function addToCart(productId) {
    const product = products.find(p => p.id === productId);
    if (!product) return;
    
    const existing = cart.find(item => item.id === productId);
    if (existing) {
        if (existing.quantity < product.stock) {
            existing.quantity++;
        } else {
            alert('Insufficient stock');
            return;
        }
    } else {
        cart.push({...product, quantity: 1});
    }
    renderCart();
}

function removeFromCart(productId) {
    cart = cart.filter(item => item.id !== productId);
    renderCart();
}

function updateQuantity(productId, change) {
    const item = cart.find(i => i.id === productId);
    if (!item) return;
    
    const newQty = item.quantity + change;
    if (newQty <= 0) {
        removeFromCart(productId);
    } else if (newQty <= item.stock) {
        item.quantity = newQty;
        renderCart();
    } else {
        alert('Insufficient stock');
    }
}

function clearCart() {
    if (cart.length > 0 && confirm('Clear all items from cart?')) {
        cart = [];
        renderCart();
    }
}

function renderCart() {
    const container = document.getElementById('cartItems');
    if (cart.length === 0) {
        container.innerHTML = '<div class="text-center text-muted py-4"><i class="fas fa-shopping-cart fa-3x mb-3" style="opacity: 0.3;"></i><p>Cart is empty</p></div>';
        document.getElementById('completeSaleBtn').disabled = true;
        document.getElementById('previewBtn').disabled = true;
    } else {
        container.innerHTML = cart.map(item => `
            <div class="d-flex justify-content-between align-items-center mb-3 pb-3 border-bottom">
                <div class="flex-grow-1">
                    <h6 class="mb-1">${item.name}</h6>
                    <small class="text-muted">₹${item.price.toFixed(2)} each</small>
                </div>
                <div class="d-flex align-items-center">
                    <button class="btn btn-sm btn-outline-secondary" onclick="updateQuantity(${item.id}, -1)">-</button>
                    <span class="mx-3">${item.quantity}</span>
                    <button class="btn btn-sm btn-outline-secondary" onclick="updateQuantity(${item.id}, 1)">+</button>
                    <button class="btn btn-sm btn-outline-danger ms-2" onclick="removeFromCart(${item.id})"><i class="fas fa-trash"></i></button>
                </div>
                <div class="ms-3 text-end" style="min-width: 80px;">
                    <strong>₹${(item.price * item.quantity).toFixed(2)}</strong>
                </div>
            </div>
        `).join('');
        document.getElementById('completeSaleBtn').disabled = false;
        document.getElementById('previewBtn').disabled = false;
    }
    
    const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
    document.getElementById('subtotal').textContent = `₹${subtotal.toFixed(2)}`;
    document.getElementById('total').textContent = `₹${subtotal.toFixed(2)}`;
}

function previewBill() {
    if (cart.length === 0) return;
    const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
    const modal = document.createElement('div');
    modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; display: flex; align-items: center; justify-content: center;';
    modal.innerHTML = `
        <div class="card" style="width: 600px; max-height: 90vh; overflow-y: auto;">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="fas fa-receipt me-2"></i>Bill Preview</h5>
            </div>
            <div class="card-body">
                <table class="table">
                    <thead><tr><th>Item</th><th>Qty</th><th>Price</th><th>Total</th></tr></thead>
                    <tbody>
                        ${cart.map(item => `
                            <tr>
                                <td>${item.name}</td>
                                <td>${item.quantity}</td>
                                <td>₹${item.price.toFixed(2)}</td>
                                <td>₹${(item.price * item.quantity).toFixed(2)}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
                <hr>
                <h4 class="text-end">Total: ₹${subtotal.toFixed(2)}</h4>
            </div>
            <div class="card-footer">
                <button class="btn btn-secondary" onclick="this.closest('div[style*=fixed]').remove()">Close</button>
                <button class="btn btn-success float-end" onclick="this.closest('div[style*=fixed]').remove(); completeSale();">Proceed to Payment</button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}

function completeSale() {
    if (cart.length === 0) return;
    
    const btn = document.getElementById('completeSaleBtn');
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Processing...';
    
    fetch('/pos/complete-sale/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({
            items: cart.map(item => ({
                code: item.code,
                name: item.name,
                price: item.price,
                quantity: item.quantity
            })),
            payment_method: document.getElementById('paymentMethod').value
        })
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            showBillModal(data.sale_number, data.total, data.sale_id);
            cart = [];
            renderCart();
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(err => alert('Error: ' + err))
    .finally(() => {
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-check me-2"></i>Complete Sale';
    });
}

function showBillModal(saleNumber, total, saleId) {
    const modal = document.createElement('div');
    modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; display: flex; align-items: center; justify-content: center;';
    modal.innerHTML = `
        <div class="card" style="width: 500px; max-height: 90vh; overflow-y: auto;">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0"><i class="fas fa-check-circle me-2"></i>Sale Completed</h5>
            </div>
            <div class="card-body text-center">
                <i class="fas fa-receipt fa-4x text-success mb-3"></i>
                <h4>Sale #${saleNumber}</h4>
                <h3 class="text-primary mb-4">₹${total.toFixed(2)}</h3>
                <div class="d-grid gap-2">
                    <button class="btn btn-primary" onclick="printBill(${saleId})"><i class="fas fa-print me-2"></i>Print Bill</button>
                    <button class="btn btn-outline-primary" onclick="downloadBill(${saleId})"><i class="fas fa-download me-2"></i>Download PDF</button>
                    <a href="/billing/" class="btn btn-outline-secondary"><i class="fas fa-file-invoice me-2"></i>View in Billing</a>
                    <button class="btn btn-success" onclick="this.closest('div[style*=fixed]').remove()">Close</button>
                </div>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}

function printBill(saleId) {
    window.open(`/pos/bill/${saleId}/`, '_blank');
}

function downloadBill(saleId) {
    window.location.href = `/pos/bill/${saleId}/pdf/`;
}

document.getElementById('productSearch').addEventListener('input', function(e) {
    const query = e.target.value.toLowerCase();
    if (query.length === 0) {
        renderProducts(products);
    } else {
        const filtered = products.filter(p => 
            p.name.toLowerCase().includes(query) || 
            p.code.toLowerCase().includes(query)
        );
        renderProducts(filtered);
    }
});

renderProducts(products);
renderCart();
</script>

<style>
.product-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    transition: all 0.2s;
}
</style>
{% endblock %}